<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Registro de consulta</title>
    <link rel="stylesheet" href="css/master.css" />
    <link rel="icon" href="/img/favicon.ico">
  </head>
  <body>
    <header>
      <a href="#" onclick="upload()" id="upload">
        <img src="img/reload.png" />
      </a>
      <img
        src="img/NAACAO.png"
        alt=""
      />
    </header>
    <main>
      <form id="form">
        <div class="group">
          <input type="text" id="name" autocomplete="off" required />
          <span class="highlight"></span> <span class="bar"></span>
          <label>Nome do paciente</label>
        </div>
        <div class="group">
          <input type="date" id="date" required />
          <span class="highlight"></span> <span class="bar"></span>
          <label>Data</label>
        </div>
        <div class="group">
          <input type="text" id="address" autocomplete="off" required />
          <span class="highlight"></span> <span class="bar"></span>
          <label>Endere√ßo</label>
        </div>
        <div id="risks">
          <div class="row">
            <div class="half">
              <input type="checkbox" onchange="risk('contatoComLama')" /> Teve
              contato direto com a lama
            </div>
            <div class="half">
              <input type="checkbox" onchange="risk('ideiaSuicida')" /> Idea√ß√£o
              suic√≠da
            </div>
          </div>
          <div class="row">
            <div class="half">
              <input type="checkbox" onchange="risk('tentativaSuicida')" />
              Tentativa de suic√≠dio
            </div>
            <div class="half">
              <input type="checkbox" onchange="risk('amigoFamiliarMorto')" />
              Algum familiar ou amigo morto/desaparecido
            </div>
          </div>
          <div class="row">
            <div class="half">
              <input type="checkbox" onchange="risk('testemunhouAcidente')" />
              Testemunhou o acidente
            </div>
            <div class="half">
              <input type="checkbox" onchange="risk('perdaPropriedade')" />
              Perda de propriedade
            </div>
          </div>
          <div class="row">
            <div class="half">
              <input type="checkbox" onchange="risk('perdaLaboral')" /> Perda
              laboral
            </div>
            <div class="half">
              <input type="checkbox" onchange="risk('alcoolDroga')" /> Problemas
              com √°lcool/drogas
            </div>
          </div>
          <div class="row">
            <div class="half">
              <input type="checkbox" onchange="risk('luto')" /> Luto complicado
            </div>
            <div class="half">
              <input type="checkbox" onchange="risk('violenciaDomestica')" />
              Viol√™ncia dom√©stica
            </div>
          </div>
          <div class="row">
            <div class="half">
              <input type="checkbox" onchange="risk('abusoInfantil')" /> Abuso
              infantil ou mau-trato
            </div>
          </div>
        </div>
        <div class="group">
          <textarea
            id="comments"
            autocomplete="off"
            required
            rows="3"
          ></textarea>
          <span class="highlight"></span> <span class="bar"></span>
          <label>Observa√ß√µes</label>
        </div>
        <div class="group">
          <select id="doctor">
            <option disabled selected></option>
          </select>
          <span class="highlight"></span> <span class="bar"></span>
          <label>Profissional</label>
        </div>
        <div class="group">
          <select id="doctor2">
            <option disabled selected></option>
          </select>
          <span class="highlight"></span> <span class="bar"></span>
          <label>Segundo profissional</label>
        </div>
      </form>
      <button id="submit">enviar</button>
    </main>
    <script type="text/javascript">
      const riscos = [];

      document.addEventListener('DOMContentLoaded', async () => {
        let names;
        let arr = [];
        if (!localStorage.toSend) {
          document.getElementById('upload').style.display = 'none';
        }
        try {
          names = await fetch('https://equipe.naacao.com.br/api/doctors', {
            method: 'GET',
            headers: {
              Accept: 'application/json',
              'Content-Type': 'application/json',
            },
          });
          names = await names.json();
          names.map(n => arr.push({name: n.name}));
          localStorage.setItem('doctors', JSON.stringify(arr));
        } catch (e) {
          document.getElementById('upload').style.display = 'none';
          names = JSON.parse(localStorage.doctors);
        }
        const list = document.getElementById('doctor');
        const list2 = document.getElementById('doctor2');
        for (var i = 0; i < names.length; i++) {
          var option = document.createElement('option');
          var option2 = document.createElement('option');
          option.value = names[i].name;
          option.text = names[i].name;
          option2.value = names[i].name;
          option2.text = names[i].name;
          list.appendChild(option);
          list2.appendChild(option2);
        }
        console.log(names);
      });

      document.getElementById('submit').addEventListener('click', save, false);

      function risk(prop) {
        riscos.push(prop);
      }

      function upload() {
        const data = JSON.parse(localStorage.toSend);
        Promise.all(
          data.map(async (r, i) => {
            try {
              const rawResponse = await fetch(
                'https://equipe.naacao.com.br/api/consultations',
                {
                  method: 'POST',
                  headers: {
                    Accept: 'application/json',
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(r),
                }
              );
              const content = await rawResponse.json();
              if (content.error) {
                throw 'Erro no registro de ' + r.patientName;
              }
              console.log(content);
              data[i] = false;
            } catch (e) {
              alert(e);
            }
          })
        ).then(() => {
          console.log(data);
          alert('Registros enviados com sucesso!');
          var myFilterArray = data.filter(Boolean);
          if (myFilterArray.length) {
            localStorage.setItem('toSend', JSON.stringify(myFilterArray));
          } else {
            localStorage.removeItem('toSend');
          }
        });
      }

      async function save() {
        const data = {
          patientName: document.getElementById('name').value,
          date: new Date(document.getElementById('date').value),
          address: document.getElementById('address').value,
          comments: document.getElementById('comments').value,
          doctorName: document.getElementById('doctor').value,
          doctor2Name: document.getElementById('doctor2').value,
          riscos,
        };
        if (
          !data.patientName ||
          !data.date ||
          !data.address ||
          !data.doctorName
        )
          return alert('Voc√™ precisa preencher alguns campos!');
        const sure = confirm('Tem certeza que quer salvar esse atendimento?');
        if (!sure) return null;
        else {
          if (localStorage.toSend) {
            const newArr = JSON.parse(localStorage.toSend);
            newArr.push(data);
            localStorage.setItem('toSend', JSON.stringify(newArr));
          } else {
            localStorage.setItem('toSend', JSON.stringify([data]));
          }
          alert('A consulta foi salva para envio mais tarde');
          document.getElementById('form').reset();
        }
      }
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker
            .register('service-worker.js')
            .then(reg => {
              console.log('Service worker registered! üòé', reg);
            })
            .catch(err => {
              console.log('üò• Service worker registration failed: ', err);
            });
        });
      }
    </script>
  </body>
</html>
